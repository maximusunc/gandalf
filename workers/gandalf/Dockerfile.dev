# Development Dockerfile - builds from the Gandalf repo root.
#
# Build:  docker build -t gandalf-worker -f workers/gandalf/Dockerfile.dev .
# Run:    docker run -v /path/to/graph:/app/graph:ro gandalf-worker
#
# Then in Shepherd's docker-compose.yml, reference the local image:
#
#   gandalf:
#     image: gandalf-worker
#     volumes:
#       - /path/to/graph:/app/graph:ro

# Use RENCI python base image
FROM ghcr.io/translatorsri/renci-python-image:3.11.5

ENV PYTHONHASHSEED=0

# Prevent numpy/BLAS from spawning excessive threads that compete with the event loop
ENV OMP_NUM_THREADS=2
ENV MKL_NUM_THREADS=2

# Graph loading configuration (mount mmap directory to this path)
ENV GANDALF_GRAPH_PATH=/app/graph
ENV GANDALF_GRAPH_FORMAT=auto

WORKDIR /app

# make sure all is writeable for the nru USER later on
RUN chmod -R 777 .

# Install Gandalf from local source
COPY . ./gandalf-src
RUN pip install ./gandalf-src && rm -rf ./gandalf-src

# Install worker dependencies (shepherd_utils must be pip-installable)
COPY ./workers/gandalf/requirements-dev.txt .
RUN pip install -r requirements-dev.txt

# switch to the non-root user (nru). defined in the base image
USER nru

# Copy in worker files
COPY ./workers/gandalf ./

CMD ["python", "worker.py"]
